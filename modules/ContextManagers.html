

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Context Managers &mdash; Programming in Python 8.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=bb3927b2"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="A Couple Handy Context Managers" href="../exercises/context-managers-exercise.html" />
    <link rel="prev" title="Mailroom – Decoratoring it" href="../exercises/mailroom/mailroom-decorator.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #4b2e83" >

          
          
          <a href="../index.html">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Topics in the Program</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../topics/01-setting_up/index.html">1. Setting up your Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/02-basic_python/index.html">2. Basic Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/03-recursion_booleans/index.html">3. Booleans and Recursion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/04-sequences_iteration/index.html">4. Sequences and Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/05-text_handling/index.html">5. Basic Text Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/06-exceptions/index.html">6. Exception Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/07-unit_testing/index.html">7. Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/08-dicts_sets/index.html">8. Dictionaries and Sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/09-files/index.html">9. File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/10-modules_packages/index.html">10. Modules and Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/11-argument_passing/index.html">11. Advanced Argument Passing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/12-comprehensions/index.html">12. Comprehensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/13-intro_oo/index.html">13. Intro to Object Oriented Programing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/14-magic_methods/index.html">14. Properties and Magic Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/15-subclassing/index.html">15. Subclassing and Inheritance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/16-multiple_inheritance/index.html">16. Multiple Inheritance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/17-functional_programming/index.html">17. Introduction to Functional Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/18-advanced_testing/index.html">18. Advanced Testing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../topics/99-extras/index.html">19. Extra Topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Pep8.html">Coding Style and Linting</a></li>
<li class="toctree-l2"><a class="reference internal" href="CodeReviews.html">Code Reviews</a></li>
<li class="toctree-l2"><a class="reference internal" href="PersistanceAndSerialization.html">Persistence and Serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Unicode.html">Unicode in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="IteratorsAndGenerators.html">Iterators and Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="Decorators.html">Decorators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exercises/mailroom/mailroom-decorator.html">Mailroom – Decoratoring it</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Context Managers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exercises/context-managers-exercise.html">A Couple Handy Context Managers</a></li>
<li class="toctree-l2"><a class="reference internal" href="MetaProgramming.html">Metaprogramming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exercises/mailroom/mailroom-meta.html">Mailroom – metaprogramming it!</a></li>
<li class="toctree-l2"><a class="reference internal" href="Logging.html">Logging and the logging module</a></li>
<li class="toctree-l2"><a class="reference internal" href="Debugging.html">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="NoSQL.html">No SQL Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="GraphDatabases.html">Graph Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="Concurrency.html">Concurrent Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Async.html">Asychronous Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Coroutines.html">Notes on Coroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="ThreadingMultiprocessing.html">Threading and multiprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exercises/threaded_downloader.html">Threaded Web Scraper</a></li>
<li class="toctree-l2"><a class="reference internal" href="Profiling.html">Performance and Profiling</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #4b2e83" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Programming in Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../topics/99-extras/index.html"><span class="section-number">19. </span>Extra Topics</a></li>
      <li class="breadcrumb-item active">Context Managers</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/modules/ContextManagers.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="../exercises/mailroom/mailroom-decorator.html" class="btn btn-neutral float-left" title="Mailroom – Decoratoring it" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../exercises/context-managers-exercise.html" class="btn btn-neutral float-right" title="A Couple Handy Context Managers" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="context-managers">
<span id="id1"></span><h1>Context Managers<a class="headerlink" href="#context-managers" title="Link to this heading"></a></h1>
<p>You’ve seen the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement – probably used for working with files. Now you’ll learn what that’s all about.</p>
<section id="managing-resources">
<h2>Managing Resources<a class="headerlink" href="#managing-resources" title="Link to this heading"></a></h2>
<p><strong>Repetition in code stinks (DRY!)</strong></p>
<p>A large source of repetition in code deals with the handling of external
resources.</p>
<p>As an example, how many times do you think you might type something like the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">file_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;filename.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">file_content</span> <span class="o">=</span> <span class="n">file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">file_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># do some stuff with the contents</span>
</pre></div>
</div>
<p>Not only is this a couple extra lines of code to write, it’s also prone to error:</p>
<p>What happens if you forget to call <code class="docutils literal notranslate"><span class="pre">.close()</span></code>?</p>
<p>What happens if reading the file raises an exception?</p>
<p>So you really should write it something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">file_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The file couldn&#39;t be opened&quot;</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">file_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>And that is getting pretty ugly, and hard to get right.</p>
<section id="handling-general-resources">
<h3>Handling General Resources<a class="headerlink" href="#handling-general-resources" title="Link to this heading"></a></h3>
<p>Leaving an open file handle laying around is bad enough. What if the resource
is a network connection, or a database cursor?</p>
<p>Starting in version 2.5, Python provides a structure for reducing the
repetition needed to handle resources like this.</p>
<p><strong>Context Managers</strong></p>
<p>You can encapsulate the setup, error handling, and teardown of resources in a
few simple steps.</p>
<p>The key is to use the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement.</p>
</section>
<section id="with-a-little-help">
<h3><code class="docutils literal notranslate"><span class="pre">with</span></code> a little help<a class="headerlink" href="#with-a-little-help" title="Link to this heading"></a></h3>
<p>Since the introduction of the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement in <a class="reference external" href="https://www.python.org/dev/peps/pep-0343/">pep343</a>, the above seven lines of defensive code have been replaced with this simple form:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handle</span><span class="p">:</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1"># do something with file_content</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">open</span></code> builtin is defined as a <em>context manager</em>.</p>
<p>The resource it returns (<code class="docutils literal notranslate"><span class="pre">file_handle</span></code>) is automatically and reliably closed
when the code block ends.</p>
<p>At this point in Python history, many functions you might expect to behave this way do:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">open</span></code> works as a context manager.</p></li>
<li><p>network connections via <code class="docutils literal notranslate"><span class="pre">socket</span></code> do as well.</p></li>
<li><p>most implementations of database wrappers can open connections or cursors as
context managers.</p></li>
<li><p>…</p></li>
<li><p>But what if you are working with a library that doesn’t support this
(<code class="docutils literal notranslate"><span class="pre">urllib</span></code>)?</p></li>
</ul>
</section>
<section id="close-it-automatically">
<h3>Close It Automatically<a class="headerlink" href="#close-it-automatically" title="Link to this heading"></a></h3>
<p>There are a couple of ways you can go.</p>
<p>If the resource in questions has a <code class="docutils literal notranslate"><span class="pre">.close()</span></code> method, then you can simply use the <code class="docutils literal notranslate"><span class="pre">closing</span></code> context manager from <code class="docutils literal notranslate"><span class="pre">contextlib</span></code> to handle the issue:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">urllib</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">closing</span>

<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">&#39;http://google.com&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">web_connection</span><span class="p">:</span>
    <span class="c1"># do something with the open resource</span>
<span class="c1"># and here, it will be closed automatically</span>
</pre></div>
</div>
<p>But what if the thing doesn’t have a <code class="docutils literal notranslate"><span class="pre">close()</span></code> method, or you’re creating
the thing and it shouldn’t have a <code class="docutils literal notranslate"><span class="pre">close()</span></code> method?</p>
<p>(full confession: <code class="docutils literal notranslate"><span class="pre">urlib.request</span></code> was not a context manager in py2 – but it is in py3 – but the issue still comes up with third-party packages and your own code!)</p>
</section>
<section id="do-it-yourself">
<h3>Do It Yourself<a class="headerlink" href="#do-it-yourself" title="Link to this heading"></a></h3>
<p>If you do need to support resource management of some sort, you can create a context manager of your own with the context manager protocol.</p>
<p>The interface is simple.  It must be a class that implements two
more of the nifty python <em>special methods</em></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">__enter__(self)</span></code>:</dt><dd><p>Called when the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement is run, it should return something to work with in the created context.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">__exit__(self,</span> <span class="pre">e_type,</span> <span class="pre">e_val,</span> <span class="pre">e_traceback)</span></code>:</dt><dd><p>Clean-up that needs to happen is implemented here.</p>
</dd>
</dl>
<p>The arguments will be the exception raised in the context.</p>
<p>If the exception will be handled here, return <code class="docutils literal notranslate"><span class="pre">True</span></code>. If not, return <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<p>Let’s see this in action to get a sense of what happens.</p>
</section>
<section id="an-example">
<h3>An Example<a class="headerlink" href="#an-example" title="Link to this heading"></a></h3>
<p>Consider this code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Context</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;from Doug Hellmann, PyMOTW</span>
<span class="sd">    https://pymotw.com/3/contextlib/#module-contextlib</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle_error</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;__init__(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">handle_error</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span> <span class="o">=</span> <span class="n">handle_error</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;__enter__()&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;__exit__(</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span>
</pre></div>
</div>
<p><a class="reference download internal" download="" href="../_downloads/1cd83ce40e4950c45c2c6377ed05f15b/context_manager.py"><code class="xref download docutils literal notranslate"><span class="pre">context_manager.py</span></code></a></p>
<p>This class doesn’t do much of anything, but playing with it can help
clarify the order in which things happen:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [46]: </span><span class="k">with</span> <span class="n">Context</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
<span class="go">    ....:     print(&#39;This is in the context&#39;)</span>
<span class="go">    ....:     raise RuntimeError(&#39;this is the error message&#39;)</span>
<span class="go">    ....:</span>
<span class="go">__init__(True)</span>
<span class="go">__enter__()</span>
<span class="go">This is in the context</span>
<span class="go">__exit__(&lt;class &#39;RuntimeError&#39;&gt;, this is the error message,</span>
<span class="go">         &lt;traceback object at 0x1047873c8&gt;)</span>
</pre></div>
</div>
<p>Because the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, the raised error is ‘handled’.</p>
<p>What if we try with <code class="docutils literal notranslate"><span class="pre">False</span></code>?</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="k">with</span> <span class="n">Context</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
<span class="gp">   ...: </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;this is in the context&quot;</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;this is the error message&#39;</span><span class="p">)</span>
<span class="gp">   ...:</span>
<span class="go">__init__(False)</span>
<span class="go">__enter__()</span>
<span class="go">this is in the context</span>
<span class="go">__exit__(&lt;class &#39;RuntimeError&#39;&gt;, this is the error message, &lt;traceback object at 0x10349e888&gt;)</span>
<span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">RuntimeError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-3-8837b3d7f123&gt;</span> in <span class="ni">&lt;module&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">with</span> <span class="n">Context</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;this is in the context&quot;</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;this is the error message&#39;</span><span class="p">)</span>

<span class="ne">RuntimeError</span>: this is the error message
</pre></div>
</div>
<p>So this time, the context manager did not catch the error – so it was raised in the usual way.</p>
</section>
<section id="the-parameters-to-exit">
<h3>The parameters to <code class="docutils literal notranslate"><span class="pre">__exit__</span></code><a class="headerlink" href="#the-parameters-to-exit" title="Link to this heading"></a></h3>
<p>In real life, a context manager could have pretty much any error raised in its context.  And the context manager will likely only be able to “properly” handle particular Exceptions.</p>
<p>So the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method takes all the information about the exception as parameters:</p>
<p><code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">__exit__(self,</span> <span class="pre">exc_type,</span> <span class="pre">exc_val,</span> <span class="pre">exc_tb)</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">exc_type</span></code>: the type of the Exception</p>
<p><code class="docutils literal notranslate"><span class="pre">exc_val</span></code>: the value of the Exception</p>
<p><code class="docutils literal notranslate"><span class="pre">exc_tb</span></code>: the Exception Traceback object</p>
<p>The type lets you check if this is a type you know how to handle:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</pre></div>
</div>
<p>The value is the exception object itself.</p>
<p>And the traceback is a full traceback object. Traceback objects hold all the information about the context in which an error occurred. It’s pretty advanced stuff, so you can mostly ignore it, but if you want to know more, there are tools for working with them in the <code class="docutils literal notranslate"><span class="pre">traceback</span></code> module.</p>
<p><a class="reference external" href="https://docs.python.org/3/library/traceback.html">https://docs.python.org/3/library/traceback.html</a></p>
</section>
<section id="the-contextmanager-decorator">
<h3>The <code class="docutils literal notranslate"><span class="pre">contextmanager</span></code> decorator<a class="headerlink" href="#the-contextmanager-decorator" title="Link to this heading"></a></h3>
<p>Similar to writing iterable classes, there’s a fair bit of bookkeeping involved. It turns out you can take advantage of generator functions to do that bookkeeping for you.</p>
<p><code class="docutils literal notranslate"><span class="pre">contextlib.contextmanager</span></code> decorator will turn a generator function into context manager.</p>
<p>Consider this code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">context</span><span class="p">(</span><span class="n">boolean</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__init__ code here&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__enter__ code goes here&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="nb">object</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;errors handled here&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">boolean</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__exit__ cleanup goes here&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The code is similar to the class defined previously.</p>
<p>And using it has similar results.  We can handle errors:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [96]: </span><span class="k">with</span> <span class="n">context</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in the context&quot;</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;error raised&quot;</span><span class="p">)</span>
<span class="gp">   ....:</span>
<span class="go">__init__ code here</span>
<span class="go">__enter__ code goes here</span>
<span class="go">in the context</span>
<span class="go">errors handled here</span>
<span class="go">__exit__ cleanup goes here</span>
</pre></div>
</div>
<p>Or, we can allow them to propagate:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [51]: </span><span class="k">with</span> <span class="n">context</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
<span class="gp">   ....: </span>   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in the context&quot;</span><span class="p">)</span>
<span class="gp">   ....: </span>   <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;error raised&quot;</span><span class="p">)</span>
<span class="go">__init__ code here</span>
<span class="go">__enter__ code goes here</span>
<span class="go">in the context</span>
<span class="go">errors handled here</span>
<span class="go">__exit__ cleanup goes here</span>
<span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">RuntimeError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-51-641528ffa695&gt;</span> in <span class="ni">&lt;module&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">with</span> <span class="n">context</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span> <span class="s2">&quot;in the context&quot;</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;error raised&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>
<span class="ne">RuntimeError</span>: error raised
</pre></div>
</div>
</section>
<section id="mixing-context-managers-with-generators">
<h3>Mixing context_managers with generators<a class="headerlink" href="#mixing-context-managers-with-generators" title="Link to this heading"></a></h3>
<p>You can put a <code class="docutils literal notranslate"><span class="pre">yield</span></code> inside a context manager as well.</p>
<p>here is a generator function that gives yields all the files in a directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>

<span class="k">def</span><span class="w"> </span><span class="nf">file_yielder</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    iterate over all the files that match the pattern</span>

<span class="sd">    pattern use a &quot;glob&quot; pattern, like: *.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_obj</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">file_obj</span>
</pre></div>
</div>
<p><a class="reference download internal" download="" href="../_downloads/d296af27e123626bc6a13f14a2f2a942/file_yielder.py"><code class="xref download docutils literal notranslate"><span class="pre">file_yielder.py</span></code></a></p>
<p>So the <code class="docutils literal notranslate"><span class="pre">yield</span></code> is inside the file context manager, so that state will be preserved while the file object is in use.</p>
<p>This generator can be used like so:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [20]: </span><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_yielder</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
<span class="go">    ...:     print(&quot;The first line of: {} is:\n{}&quot;.format(f.name, f.readline()))</span>
</pre></div>
</div>
<p>Each iteration through the loop, the previous file gets closed, and the new one opened.  If there is an exception raised inside that loop, the last file will get properly closed.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../exercises/mailroom/mailroom-decorator.html" class="btn btn-neutral float-left" title="Mailroom – Decoratoring it" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../exercises/context-managers-exercise.html" class="btn btn-neutral float-right" title="A Couple Handy Context Managers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Natasha Aleksandrova, Christopher Barker, Brian Dorsey, Cris Ewing, Christy Heaton, Jon Jacky, Maria McKinley, Andy Miles, Rick Riehle, Joseph Schilz, Joseph Sheedy, Hosung Song. Creative Commons Attribution-ShareAlike 4.0 license.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>